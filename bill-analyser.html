<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellness - Smart Medical Bill Analyzer</title>
    <style>
        :root {
            --primary: #1e88e5;
            --primary-dark: #1565c0;
            --secondary: #26a69a;
            --accent: #ff7043;
            --light: #f5f5f5;
            --dark: #333;
            --danger: #e53935;
            --success: #43a047;
            --warning: #ffb300;
            --font: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Wellness Medical Bill Analyzer Styles */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #2563eb;
    --secondary: #10b981;
    --accent: #f59e0b;
    --danger: #ef4444;
    --warning: #f97316;
    --success: #22c55e;
    --dark: #1f2937;
    --light: #f8fafc;
    --border: #e5e7eb;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    background-color: var(--light);
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

/* Header Styles */
.header {
    background: white;
    box-shadow: var(--shadow);
    padding: 1rem 0;
    margin-bottom: 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
}

.navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.logo {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: var(--primary);
    font-weight: bold;
}

.logo img {
    width: 40px;
    height: 40px;
    margin-right: 10px;
}

.logo h1 {
    font-size: 1.5rem;
    color: var(--primary);
}

.mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--primary);
}

.nav-links {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.nav-links a {
    text-decoration: none;
    color: #333;
    font-weight: 500;
    transition: color 0.3s ease;
}

.nav-links a:hover {
    color: var(--primary);
}

.health-coins {
    display: flex;
    align-items: center;
    gap: 5px;
    background: linear-gradient(135deg, #ffd700, #ffed4a);
    padding: 8px 12px;
    border-radius: 20px;
    font-weight: bold;
    color: #8b5000;
}

.translate-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s ease;
}

.translate-btn:hover {
    background: #1d4ed8;
}

.translate-btn img {
    width: 16px;
    height: 16px;
}

/* Main Content Styles */
h1 {
    color: var(--primary);
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2.5rem;
    font-weight: 700;
}

/* Configuration Section */
.config-section {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border);
}

.config-section h3 {
    color: var(--dark);
    margin-bottom: 1rem;
    font-size: 1.25rem;
}

.config-section input,
.config-section select {
    width: 100%;
    max-width: 400px;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
    margin-bottom: 1rem;
}

.config-section input:focus,
.config-section select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.config-section small {
    color: #666;
    font-size: 12px;
    display: block;
    margin-top: 5px;
}

/* Upload Section */
.upload-section {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border);
}

.upload-section h3 {
    color: var(--dark);
    margin-bottom: 1rem;
    font-size: 1.25rem;
}

#prescription-file {
    width: 100%;
    padding: 12px 16px;
    border: 2px dashed var(--border);
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: border-color 0.3s ease;
    background: #fafafa;
}

#prescription-file:hover {
    border-color: var(--primary);
    background: #f0f7ff;
}

/* Button Styles */
.btn {
    display: inline-block;
    padding: 12px 24px;
    background: var(--primary);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
    text-align: center;
}

.btn:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
    box-shadow: var(--shadow-lg);
}

.btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-outline {
    background: transparent;
    color: var(--primary);
    border: 2px solid var(--primary);
}

.btn-outline:hover {
    background: var(--primary);
    color: white;
}

/* Status Display */
#status {
    margin: 20px 0;
    padding: 15px 20px;
    border-radius: 8px;
    font-weight: 500;
    border-left: 4px solid;
    display: none;
}

#status.info {
    background-color: #eff6ff;
    border-color: var(--primary);
    color: #1e40af;
}

#status.success {
    background-color: #f0fdf4;
    border-color: var(--success);
    color: #166534;
}

#status.error {
    background-color: #fef2f2;
    border-color: var(--danger);
    color: #dc2626;
}

/* Results Section */
#results {
    margin-top: 2rem;
}

.analysis-result {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    padding: 2rem;
    border: 1px solid var(--border);
}

.analysis-result h2 {
    color: var(--dark);
    margin-bottom: 1rem;
    font-size: 1.8rem;
    text-align: center;
}

.analysis-result h3 {
    color: var(--dark);
    margin: 1.5rem 0 1rem 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.analysis-result h4 {
    color: var(--dark);
    margin: 1rem 0 0.5rem 0;
    font-size: 1.1rem;
}

/* Summary Cards */
.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin: 25px 0;
}

.summary-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    border: 2px solid;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
}

.summary-card:hover {
    transform: translateY(-2px);
}

.summary-card.unnecessary {
    border-color: var(--danger);
    background: linear-gradient(135deg, #fef2f2, #ffffff);
}

.summary-card.overpriced {
    border-color: var(--warning);
    background: linear-gradient(135deg, #fef3c0, #ffffff);
}

.summary-card.savings {
    border-color: var(--success);
    background: linear-gradient(135deg, #ecfdf5, #ffffff);
}

.summary-card h4 {
    font-size: 1.1rem;
    margin-bottom: 5px;
}

.summary-card.unnecessary h4 {
    color: var(--danger);
}

.summary-card.overpriced h4 {
    color: var(--warning);
}

.summary-card.savings h4 {
    color: var(--success);
}

/* Tables */
.medicine-table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--shadow);
}

.medicine-table thead {
    background: var(--primary);
    color: white;
}

.medicine-table th,
.medicine-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.medicine-table th {
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.medicine-table tbody tr:hover {
    background-color: #f8fafc;
}

.medicine-table tbody tr:last-child td {
    border-bottom: none;
}

/* Medicine Categories */
.medicine-category {
    margin: 30px 0;
    padding: 20px;
    border-radius: 10px;
    background: white;
    box-shadow: var(--shadow);
}

.medicine-item {
    border-radius: 8px;
    padding: 20px;
    margin: 15px 0;
    border-left: 4px solid;
}

.medicine-item.unnecessary {
    background: #fef2f2;
    border-color: var(--danger);
}

.medicine-item.overpriced {
    background: #fef3c0;
    border-color: var(--warning);
}

.medicine-item.commission {
    background: #f3e8ff;
    border-color: #7c3aed;
}

/* Medicine Flags */
.medicine-flag {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.flag-unnecessary {
    background: var(--danger);
    color: white;
}

.flag-overpriced {
    background: var(--warning);
    color: white;
}

.flag-commission {
    background: #7c3aed;
    color: white;
}

/* Alternatives */
.alternatives {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.alternative-item {
    display: inline-block;
    background: rgba(34, 197, 94, 0.1);
    color: var(--success);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 500;
}

/* Info Boxes */
.info-box {
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border-left: 4px solid;
}

.info-box.summary {
    background: #f0f9ff;
    border-color: #0ea5e9;
    color: #0369a1;
}

.info-box.disclaimer {
    background: #fef3c0;
    border-color: var(--warning);
    color: #92400e;
}

.info-box h3,
.info-box h4 {
    margin-bottom: 10px;
    color: inherit;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 30px 0;
    flex-wrap: wrap;
}

.download-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--success);
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.download-btn:hover {
    background: #16a34a;
    transform: translateY(-1px);
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 0 15px;
    }

    .mobile-menu-btn {
        display: block;
    }

    .nav-links {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        flex-direction: column;
        padding: 20px;
        box-shadow: var(--shadow-lg);
        gap: 1rem;
    }

    .nav-links.active {
        display: flex;
    }

    h1 {
        font-size: 2rem;
    }

    .config-section,
    .upload-section {
        padding: 1.5rem;
    }

    .config-section input,
    .config-section select {
        max-width: 100%;
    }

    .summary-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .medicine-table {
        font-size: 14px;
    }

    .medicine-table th,
    .medicine-table td {
        padding: 8px 10px;
    }

    .action-buttons {
        flex-direction: column;
        align-items: center;
    }

    .btn,
    .download-btn {
        width: 100%;
        max-width: 300px;
    }
}

@media (max-width: 480px) {
    h1 {
        font-size: 1.5rem;
    }

    .config-section,
    .upload-section,
    .analysis-result {
        padding: 1rem;
    }

    .medicine-table {
        font-size: 12px;
    }

    .medicine-table th,
    .medicine-table td {
        padding: 6px 8px;
    }
}

/* Loading States */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Animations */
.fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #1d4ed8;
}

/* Print Styles */
@media print {
    body {
        background: white;
        color: black;
    }

    .config-section,
    .upload-section,
    .action-buttons {
        display: none;
    }

    .analysis-result {
        box-shadow: none;
        border: 1px solid #000;
    }
}

/* Accessibility */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Focus indicators */
button:focus,
input:focus,
select:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    :root {
        --border: #000;
        --shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Medical Bill Analyzer</h1>
        
        <!-- API Configuration -->
        <div class="config-section">
            <h3>API Configuration</h3>
            <input type="text" id="gemini-api-key" placeholder="Enter Gemini API Key" style="width: 300px; margin-bottom: 10px;">
            <br>
            <select id="ocr-model" style="width: 300px; margin-bottom: 10px;">
                <option value="RolmOCR">RolmOCR (Default)</option>
                <option value="PaddleOCR">PaddleOCR</option>
                <option value="TrOCR">TrOCR</option>
            </select>
            <br>
            <small>Note: OCR uses Gradio client - no additional API key needed</small>
        </div>
        
        <br>
        
        <!-- File Upload Section -->
        <div class="upload-section">
            <h3>Upload Prescription/Medical Bill</h3>
            <input type="file" id="prescription-file" accept="image/*,.pdf" style="margin-bottom: 10px;">
            <br>
            <button id="analyze-btn">Analyze Prescription</button>
        </div>
        
        <br>
        
        <!-- Status Display -->
        <div id="status" style="margin: 20px 0; padding: 10px; border-radius: 5px;"></div>
        
        <!-- Results Section -->
        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <!-- Gradio Client CDN -->
    <script type="module">
        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client@1.1.0/dist/index.min.js";
        
        // Configuration
        const CONFIG = {
            GRADIO_SPACE: "davanstrien/ocr-time-machine",
            GEMINI_API_BASE: "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent"
        };

        // DOM Elements
        const geminiApiKeyInput = document.getElementById('gemini-api-key');
        const ocrModelSelect = document.getElementById('ocr-model');
        const prescriptionFileInput = document.getElementById('prescription-file');
        const analyzeBtn = document.getElementById('analyze-btn');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        // Utility Functions
        function showStatus(message, type = 'info') {
            statusDiv.innerHTML = message;
            statusDiv.style.backgroundColor = type === 'error' ? '#fee' : 
                                           type === 'success' ? '#efe' : '#eef';
            statusDiv.style.border = `1px solid ${type === 'error' ? '#fcc' : 
                                                 type === 'success' ? '#cfc' : '#ccf'}`;
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        // OCR Function using Gradio Client for davanstrien/ocr-time-machine
        async function extractTextFromImage(imageFile) {
            showStatus('Connecting to OCR service...', 'info');

            try {
                // Connect to the Gradio space
                const client = await Client.connect(CONFIG.GRADIO_SPACE);
                
                showStatus('Processing image with OCR...', 'info');
                
                // Get selected model
                const selectedModel = ocrModelSelect.value;
                
                // Call the /process_files endpoint
                // Note: xml_path is optional, we'll pass null or the same file
                const result = await client.predict("/process_files", { 
                    image_path: imageFile,
                    xml_path: null, // Optional XML file for ALTO or PAGE format
                    model_name: selectedModel
                });

                console.log('OCR Result:', result);
                
                // The result contains 5 elements:
                // [0] - Uploaded Document Image
                // [1] - XML Reading Order Text
                // [2] - Markdown Format (this is what we want)
                // [3] - VLM OCR Download
                // [4] - XML Text Download
                
                let extractedText = '';
                
                if (result.data && result.data.length >= 3) {
                    // Try to get text from markdown format (index 2)
                    extractedText = result.data[2] || '';
                    
                    // If markdown is empty, try XML reading order (index 1)
                    if (!extractedText && result.data[1]) {
                        extractedText = result.data[1];
                    }
                } else {
                    throw new Error('Unexpected response format from OCR service');
                }

                if (!extractedText.trim()) {
                    throw new Error('No text could be extracted from the image. Please ensure the image contains readable text.');
                }

                showStatus(`Text extracted successfully! Found ${extractedText.length} characters.`, 'success');
                return extractedText;

            } catch (error) {
                console.error('OCR Error:', error);
                
                // Provide more specific error messages
                if (error.message.includes('fetch')) {
                    throw new Error('Failed to connect to OCR service. Please check your internet connection.');
                } else if (error.message.includes('predict')) {
                    throw new Error('OCR processing failed. Please try with a different image or model.');
                } else {
                    throw new Error(`OCR failed: ${error.message}`);
                }
            }
        }

        // Remove the fileToBase64 function as it's no longer needed with Gradio client

        // Analyze prescription using Gemini API
        async function analyzePrescriptionWithGemini(extractedText) {
            const apiKey = geminiApiKeyInput.value.trim();
            if (!apiKey) {
                throw new Error('Gemini API key is required');
            }

            showStatus('Analyzing prescription with Gemini AI...', 'info');

            const prompt = `
            Analyze the following medical prescription/bill text and provide a detailed analysis in JSON format:

            Prescription Text:
            "${extractedText}"

            Please analyze and return ONLY a valid JSON object with the following structure:
            {
                "extractedMedicines": [
                    {
                        "name": "Medicine name",
                        "dosage": "Dosage if mentioned",
                        "price": "Price if mentioned (number only, no currency symbol)",
                        "frequency": "Frequency if mentioned"
                    }
                ],
                "unnecessaryMedicines": [
                    {
                        "name": "Medicine name",
                        "price": "Price (number only)",
                        "reason": "Detailed reason why it might be unnecessary",
                        "recommendation": "Alternative recommendation"
                    }
                ],
                "overpricedMedicines": [
                    {
                        "name": "Medicine name", 
                        "currentPrice": "Current price (number only)",
                        "reason": "Why it's considered overpriced",
                        "alternatives": [
                            {
                                "name": "Alternative medicine name",
                                "estimatedPrice": "Estimated price (number only)"
                            }
                        ]
                    }
                ],
                "potentialCommissionBased": [
                    {
                        "name": "Medicine name",
                        "currentPrice": "Current price (number only)", 
                        "reason": "Why it might be commission-based",
                        "alternatives": [
                            {
                                "name": "Alternative medicine name",
                                "estimatedPrice": "Estimated price (number only)"
                            }
                        ]
                    }
                ],
                "doctorInfo": {
                    "name": "Doctor name if found",
                    "clinic": "Clinic/hospital name if found"
                },
                "diagnosis": "Condition/diagnosis if mentioned",
                "totalEstimatedSavings": "Total potential savings (number only)",
                "summary": "Brief summary of the analysis",
                "disclaimer": "Important medical disclaimer"
            }

            Important guidelines:
            1. Base analysis on standard medical practices and drug pricing in India
            2. Only flag medicines as unnecessary if there's clear medical justification
            3. Consider generic vs branded medicine pricing
            4. Provide constructive alternatives, not just criticism
            5. Include appropriate medical disclaimers
            6. Return ONLY the JSON object, no additional text
            `;

            try {
                const response = await fetch(`${CONFIG.GEMINI_API_BASE}?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            topK: 1,
                            topP: 1,
                            maxOutputTokens: 2048,
                        },
                        safetySettings: [
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH", 
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Gemini API Error: ${errorData.error?.message || response.statusText}`);
                }

                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0] || !result.candidates[0].content) {
                    throw new Error('Invalid response from Gemini API');
                }

                const analysisText = result.candidates[0].content.parts[0].text;
                
                // Clean the response text and parse JSON
                const cleanedText = analysisText.replace(/```json\n?|\n?```/g, '').trim();
                
                try {
                    const analysisResult = JSON.parse(cleanedText);
                    showStatus('Analysis completed successfully!', 'success');
                    return analysisResult;
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.log('Raw response:', analysisText);
                    throw new Error('Failed to parse analysis result. Please try again.');
                }

            } catch (error) {
                console.error('Gemini API Error:', error);
                throw new Error(`Analysis failed: ${error.message}`);
            }
        }

        // Display analysis results
        function displayResults(analysisData) {
            let html = `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: white;">
                    <h2>Prescription Analysis Results</h2>
                    
                    ${analysisData.doctorInfo?.name ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                        <h3>Prescription Details</h3>
                        <p><strong>Doctor:</strong> ${analysisData.doctorInfo.name}</p>
                        ${analysisData.doctorInfo.clinic ? `<p><strong>Clinic:</strong> ${analysisData.doctorInfo.clinic}</p>` : ''}
                        ${analysisData.diagnosis ? `<p><strong>Diagnosis:</strong> ${analysisData.diagnosis}</p>` : ''}
                    </div>
                    ` : ''}

                    ${analysisData.extractedMedicines && analysisData.extractedMedicines.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #2563eb;">📋 Extracted Medicines</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Medicine</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Dosage</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Frequency</th>
                                        <th style="border: 1px solid #ddd; padding: 10px; text-align: left;">Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${analysisData.extractedMedicines.map(med => `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 10px;">${med.name}</td>
                                            <td style="border: 1px solid #ddd; padding: 10px;">${med.dosage || 'N/A'}</td>
                                            <td style="border: 1px solid #ddd; padding: 10px;">${med.frequency || 'N/A'}</td>
                                            <td style="border: 1px solid #ddd; padding: 10px;">₹${med.price || 'N/A'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <div style="background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 15px;">
                            <h4 style="color: #dc2626; margin-bottom: 10px;">⚠️ Unnecessary Medicines: ${analysisData.unnecessaryMedicines?.length || 0}</h4>
                        </div>
                        <div style="background: #fef3c0; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px;">
                            <h4 style="color: #d97706; margin-bottom: 10px;">💰 Overpriced Medicines: ${analysisData.overpricedMedicines?.length || 0}</h4>
                        </div>
                        <div style="background: #ecfdf5; border: 1px solid #22c55e; border-radius: 8px; padding: 15px;">
                            <h4 style="color: #16a34a; margin-bottom: 10px;">💵 Potential Savings: ₹${analysisData.totalEstimatedSavings || 0}</h4>
                        </div>
                    </div>

                    ${analysisData.unnecessaryMedicines && analysisData.unnecessaryMedicines.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #dc2626;">⚠️ Potentially Unnecessary Medicines</h3>
                        ${analysisData.unnecessaryMedicines.map(med => `
                            <div style="border: 1px solid #fcc; background: #fee; border-radius: 5px; padding: 15px; margin: 10px 0;">
                                <h4>${med.name} - ₹${med.price}</h4>
                                <p><strong>Reason:</strong> ${med.reason}</p>
                                <p><strong>Recommendation:</strong> ${med.recommendation}</p>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    ${analysisData.overpricedMedicines && analysisData.overpricedMedicines.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #d97706;">💰 Overpriced Medicines</h3>
                        ${analysisData.overpricedMedicines.map(med => `
                            <div style="border: 1px solid #f59e0b; background: #fef3c0; border-radius: 5px; padding: 15px; margin: 10px 0;">
                                <h4>${med.name} - ₹${med.currentPrice}</h4>
                                <p><strong>Issue:</strong> ${med.reason}</p>
                                <p><strong>Alternatives:</strong></p>
                                <ul>
                                    ${med.alternatives?.map(alt => `
                                        <li>${alt.name} - ₹${alt.estimatedPrice} (Save ₹${med.currentPrice - alt.estimatedPrice})</li>
                                    `).join('') || '<li>No alternatives found</li>'}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    ${analysisData.potentialCommissionBased && analysisData.potentialCommissionBased.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #7c3aed;">🎯 Potential Commission-Based Prescriptions</h3>
                        ${analysisData.potentialCommissionBased.map(med => `
                            <div style="border: 1px solid #a855f7; background: #f3e8ff; border-radius: 5px; padding: 15px; margin: 10px 0;">
                                <h4>${med.name} - ₹${med.currentPrice}</h4>
                                <p><strong>Concern:</strong> ${med.reason}</p>
                                <p><strong>Alternatives:</strong></p>
                                <ul>
                                    ${med.alternatives?.map(alt => `
                                        <li>${alt.name} - ₹${alt.estimatedPrice} (Save ₹${med.currentPrice - alt.estimatedPrice})</li>
                                    `).join('') || '<li>No alternatives found</li>'}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    ${analysisData.summary ? `
                    <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h3 style="color: #0369a1;">📊 Summary</h3>
                        <p>${analysisData.summary}</p>
                    </div>
                    ` : ''}

                    <div style="background: #fef3c0; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px;">
                        <h4 style="color: #92400e;">⚠️ Important Disclaimer</h4>
                        <p style="font-size: 14px; color: #92400e;">
                            ${analysisData.disclaimer || 'This analysis is for informational purposes only and should not replace professional medical advice. Always consult with your healthcare provider before making any changes to your medication regimen.'}
                        </p>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="downloadReport()" style="background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            📄 Download Report
                        </button>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        // Download report function
        function downloadReport() {
            const reportContent = resultsDiv.innerHTML;
            const blob = new Blob([`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Medical Prescription Analysis Report</title>
                    <meta charset="utf-8">
                </head>
                <body style="font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px;">
                    ${reportContent}
                </body>
                </html>
            `], { type: 'text/html' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `medical-analysis-report-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Main analysis function
        async function analyzePrescription() {
            const file = prescriptionFileInput.files[0];
            
            if (!file) {
                showStatus('Please select a file to analyze', 'error');
                return;
            }

            if (!geminiApiKeyInput.value.trim()) {
                showStatus('Please provide Gemini API key', 'error');
                return;
            }

            clearResults();
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Processing...';

            try {
                // Step 1: Extract text using OCR
                const extractedText = await extractTextFromImage(file);
                console.log('Extracted Text:', extractedText);

                // Step 2: Analyze with Gemini
                const analysisResult = await analyzePrescriptionWithGemini(extractedText);
                console.log('Analysis Result:', analysisResult);

                // Step 3: Display results
                displayResults(analysisResult);

            } catch (error) {
                console.error('Analysis Error:', error);
                showStatus(error.message, 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze Prescription';
            }
        }

        // Event listeners
        analyzeBtn.addEventListener('click', analyzePrescription);

        // Make downloadReport function global
        window.downloadReport = downloadReport;

        // Initial setup
        showStatus('Ready to analyze prescription. Please upload a file and provide API keys.', 'info');
    </script>
</body>
</html>
